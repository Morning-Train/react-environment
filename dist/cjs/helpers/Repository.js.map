{"version":3,"file":"Repository.js","sources":["../../../src/helpers/Repository.js"],"sourcesContent":["import get from 'lodash/get';\nimport set from 'lodash/set';\nimport forEach from \"lodash/forEach\"\nimport isArray from \"lodash/isArray\"\nimport isPlainObject from \"lodash/isPlainObject\"\nimport uniqueId from \"lodash/uniqueId\"\nimport setWith from 'lodash/setWith'\nimport mergeWith from 'lodash/mergeWith'\n\nexport default class Repository {\n\n    constructor(data = {}) {\n        this.data = data;\n    }\n\n    transform(query, callback) {\n\n        let value = this.get(query);\n\n        if(typeof callback === \"function\") {\n            value = callback(value);\n        }\n\n        this.set(query, value);\n    }\n\n    get(query, defaultValue = null) {\n        if (arguments.length === 0) {\n            return this.data;\n        }\n\n        return get(this.data, query, defaultValue);\n    }\n\n    set(query, value) {\n        // Check if query is an object\n        if (typeof query === \"object\") {\n            this.data = query;\n            return this;\n        }\n\n        set(this.data, query, value);\n\n        this.triggerObserveCallbacks(query);\n\n        return this;\n    }\n\n    remove(query) {\n        let parts = query.split(\".\");\n        let key = parts.pop();\n        let parentQuery = parts.join(\".\");\n        let target = parts.length === 0 ? this.get() : this.get(parentQuery);\n\n        if (target && (typeof target === \"object\")) {\n            delete target[key];\n        }\n\n        this.triggerObserveCallbacks(query);\n\n        return this;\n    }\n\n    has(query) {\n        return this.get(query) != undefined;\n    }\n\n    empty() {\n        this.data = {};\n        return this;\n    }\n\n    isEmpty() {\n        return Object.keys(this.data) === 0;\n    }\n\n    keys() {\n        return Object.keys(this.data);\n    }\n\n    entries() {\n        return Object.values(this.data);\n    }\n\n    each(callback) {\n\n        if(typeof(callback) !== \"function\") {\n            return;\n        }\n\n        if(this.isEmpty()) {\n            return;\n        }\n\n        return this.entries().map(entry => callback(entry));\n    }\n\n    _observeCallbacks = {};\n    _observedPathsTree = {};\n\n    observe(path, callback) {\n        if (typeof this._observeCallbacks[path] === 'undefined') {\n            this._observeCallbacks[path] = {};\n        }\n\n        const uuid = uniqueId()\n\n        const disposer = () => {\n            this.removeObserveListener(path, callback);\n        }\n\n        this._observeCallbacks[path][uuid] = callback;\n\n        mergeWith(\n          this._observedPathsTree,\n          setWith({}, path, {}, Object)\n        )\n\n        return disposer;\n    }\n\n    triggerObserveCallbacks(path) {\n        return new Promise(resolve => {\n\n            const promises = []\n\n            /// Trigger for direct match\n            promises.push(\n              this.triggerObserveCallbacksForPath(path)\n            )\n\n            /// Trigger for children\n            const childObservers = get(this._observedPathsTree, path)\n            if(childObservers) {\n                const flattenedChildObservers = this._flattenObject(childObservers)\n                Object.keys(flattenedChildObservers).forEach(pathFragment => {\n                    promises.push(\n                      this.triggerObserveCallbacksForPath(path + '.' + pathFragment)\n                    )\n                })\n            }\n\n            /// Trigger for direct parents\n            const pathFragments = path.split('.')\n            pathFragments.pop()\n\n            while(pathFragments.length > 0) {\n                promises.push(\n                  this.triggerObserveCallbacksForPath(pathFragments.join('.'))\n                )\n                pathFragments.pop()\n            }\n\n            Promise.all(promises).then(() => {\n                resolve()\n            })\n        })\n    }\n\n    triggerObserveCallbacksForPath(path) {\n        return new Promise(resolve => {\n\n            const callbacksObject = this._observeCallbacks[path];\n\n            if(!callbacksObject) {\n                resolve()\n                return\n            }\n\n            const keys = Object.keys(callbacksObject)\n\n            if (typeof keys !== 'undefined' && keys.length > 0) {\n                keys.forEach(key => {\n\n                    const trigger = () => {\n\n                        if(typeof this._observeCallbacks[path] === 'object' && typeof this._observeCallbacks[path][key] === 'function') {\n                            this._observeCallbacks[path][key]()\n                        }\n\n                        resolve()\n                    }\n\n                    if(typeof requestIdleCallback === 'function') {\n                        requestIdleCallback(() => {\n                            trigger();\n                        })\n                    } else {\n                        trigger();\n                    }\n                })\n            }\n\n        })\n\n    }\n\n    removeObserveListener(path, callback) {\n\n        if(typeof this._observeCallbacks[path] === 'undefined') {\n            return;\n        }\n\n        const keys = Object.keys(this._observeCallbacks[path])\n\n        if(keys.length === 0) {\n            return;\n        }\n\n        keys.forEach((key) => {\n            if (this._observeCallbacks[path][key] === callback) {\n                delete this._observeCallbacks[path][key];\n            }\n        });\n    }\n\n    _flattenObject(obj = {}) {\n        const result = {};\n\n        const flatten = (collection, prefix = '', suffix = '') => {\n            forEach(collection, (value, key) => {\n                const path = `${prefix}${key}${suffix}`;\n\n                if (isArray(value)) {\n                    flatten(value, `${path}[`, ']');\n                } else if (isPlainObject(value) && Object.keys(value).length > 0) {\n                    flatten(value, `${path}.`);\n                }\n\n                result[path] = value;\n            });\n        };\n\n        flatten(obj);\n\n        return result;\n    }\n\n}\n"],"names":["Repository","data","_observeCallbacks","_observedPathsTree","query","callback","value","get","set","defaultValue","arguments","length","_typeof","triggerObserveCallbacks","parts","split","key","pop","parentQuery","join","target","undefined","Object","keys","values","isEmpty","entries","map","entry","path","uuid","uniqueId","disposer","removeObserveListener","mergeWith","setWith","Promise","resolve","promises","push","triggerObserveCallbacksForPath","childObservers","flattenedChildObservers","_flattenObject","forEach","pathFragment","pathFragments","all","then","callbacksObject","trigger","requestIdleCallback","obj","result","flatten","collection","prefix","suffix","isArray","isPlainObject"],"mappings":"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"}